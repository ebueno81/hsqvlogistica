@using HsqvLogistica.Models.DTOs.Usuarios
@using HsqvLogistica.Services.Interfaces
@using MudBlazor

<MudDialog>

    <DialogContent>

        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
            Complete los datos del usuario
        </MudText>

        <MudForm @ref="_form">

            <MudTextField Label="Usuario"
                          @bind-Value="_usuario"
                          Disabled="@_isEditMode"
                          Required
                          Variant="Variant.Outlined"
                          Color="Color.Primary"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Person" />

           <MudTextField Label="Nombres"
              @bind-Value="_nombres"
              Required
              Variant="Variant.Outlined"
              Color="Color.Primary"
              Adornment="Adornment.Start"
              AdornmentIcon="@Icons.Material.Filled.Badge" />

            <MudTextField Label="Correo"
                          @bind-Value="_correo"
                          Required
                          Variant="Variant.Outlined"
                          Color="Color.Primary"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Email" />

            <MudSelect T="int"
                       Label="Tipo de usuario"
                       @bind-Value="_idTipo"
                       Required
                       Dense
                       Variant="Variant.Outlined"
                       Color="Color.Primary"
                       Adornment="Adornment.Start"
                       AdornmentIcon="@Icons.Material.Filled.Security">

                @foreach (var tipo in TiposUsuario)
                {
                    <MudSelectItem Value="@tipo.Id">
                        @tipo.Descripcion
                    </MudSelectItem>
                }
            </MudSelect>

            <MudDivider Class="my-3" />

            @if (!_isEditMode)
            {
                <!-- CREAR -->
                <MudTextField Label="Clave"
                              @bind-Value="_clave"
                              InputType="InputType.Password"
                              Required
                              Variant="Variant.Outlined"
                              Color="Color.Primary"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Lock" />

                <MudTextField Label="Confirmar clave"
                              @bind-Value="_confirmarClave"
                              InputType="InputType.Password"
                              Required
                              Variant="Variant.Outlined"
                              Color="Color.Primary"
                              Error="@_claveError"
                              ErrorText="Las claves no coinciden"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.LockReset" />
            }
            else
            {
                <!-- EDITAR -->
                <MudTextField Label="Nueva clave (opcional)"
                              @bind-Value="_clave"
                              InputType="InputType.Password"
                              Variant="Variant.Outlined"
                              Color="Color.Primary"
                              HelperText="Dejar vacío si no desea cambiarla"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.VpnKey" />
            }

        </MudForm>

    </DialogContent>

    <DialogActions>
        <MudButton OnClick="Cancel">Cancelar</MudButton>

        <MudButton Color="Color.Primary"
                   Variant="Variant.Filled"
                   OnClick="Save">
            @(_isEditMode ? "Actualizar" : "Guardar")
        </MudButton>
    </DialogActions>

</MudDialog>

@code {

    [CascadingParameter]
    IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter]
    public UsuarioDto? Usuario { get; set; }

    [Inject]
    public IUsuarioService UsuarioService { get; set; } = default!;

    [Inject]
    public ITipoUsuarioService TipoUsuarioService { get; set; } = default!;

    MudForm? _form;
    bool _isEditMode;
    bool _claveError;

    string _usuario = string.Empty;
    string _nombres = string.Empty;
    string _correo = string.Empty;
    int _idTipo=1;
    string _clave = string.Empty;
    string _confirmarClave = string.Empty;

    List<TipoUsuarioLookupDto> TiposUsuario = new();

    protected override async Task OnParametersSetAsync()
    {
        TiposUsuario = (await TipoUsuarioService.GetLookupAsync()).ToList();

        if (Usuario != null)
        {
            _isEditMode = true;
            _usuario = Usuario.Usuario!;
            _nombres = Usuario.Nombres!;
            _correo = Usuario.Correo!;

            _idTipo = Usuario.IdTipo;
            StateHasChanged();
        }
    }

    async Task Save()
    {
        if (_form is null) return;

        _claveError = false;

        await _form.Validate();
        if (!_form.IsValid) return;

        // 🔐 Validación de clave
        if (!_isEditMode)
        {
            if (_clave != _confirmarClave)
            {
                _claveError = true;
                return;
            }
        }

        if (_isEditMode && Usuario != null)
        {
            await UsuarioService.UpdateAsync(
                Usuario.Id,
                new UsuarioUpdateDto
                {
                    Nombres = _nombres,
                    Correo = _correo,
                    IdTipo = _idTipo,
                    Clave = string.IsNullOrWhiteSpace(_clave) ? null : _clave
                });
        }
        else
        {
            await UsuarioService.CreateAsync(
                new UsuarioCreateDto
                {
                    Usuario = _usuario,
                    Nombres = _nombres,
                    Correo = _correo,
                    Clave = _clave,
                    IdTipo = _idTipo
                });
        }

        MudDialog.Close(DialogResult.Ok(true));
    }

    void Cancel() => MudDialog.Cancel();
}
