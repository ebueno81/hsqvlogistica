@page "/pedidos"

@using HsqvLogistica.Components.Pages.Dialogs
@using HsqvLogistica.Models.DTOs.Pedidos
@using HsqvLogistica.Services.Interfaces
@using MudBlazor

@inject IPedidoService PedidoService
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-6">

    <!-- ================= CABECERA ================= -->
    <MudStack Direction="Row"
              Justify="Justify.SpaceBetween"
              AlignItems="AlignItems.Center"
              Class="mb-4">

        <MudText Typo="Typo.h5">Pedidos</MudText>

        <MudButton Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.Add"
                   OnClick="GoNuevoPedido"
                   Disabled="@_isNavigating">
            Nuevo Pedido
        </MudButton>

    </MudStack>

    <!-- ================= FILTROS ================= -->
    <MudPaper Elevation="1" Class="pa-4 mb-4">

        <MudGrid Spacing="3">

            <MudItem xs="12" md="4">
                <MudTextField Label="Cliente"
                              @bind-Value="_cliente"
                              Variant="Variant.Outlined"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search" />
            </MudItem>

            <MudItem xs="12" md="3">
                <MudDatePicker Label="Desde"
                               @bind-Date="_fechaDesde"
                               Variant="Variant.Outlined" />
            </MudItem>

            <MudItem xs="12" md="3">
                <MudDatePicker Label="Hasta"
                               @bind-Date="_fechaHasta"
                               Variant="Variant.Outlined" />
            </MudItem>

            <MudItem xs="12" md="2" Class="d-flex align-end">
                <MudButton Color="Color.Primary"
                           Variant="Variant.Filled"
                           OnClick="Buscar">
                    Buscar
                </MudButton>
            </MudItem>

        </MudGrid>

    </MudPaper>

    <!-- ================= TABLA ================= -->
    <MudPaper Elevation="2" Class="pa-4">

        <MudTable T="PedidoDto"
                  @ref="_table"
                  ServerData="LoadServerData"
                  Dense
                  Hover
                  Striped
                  Loading="_loading"
                  RowsPerPage="10">

            <HeaderContent>
                <MudTh>#</MudTh>
                <MudTh>Cliente</MudTh>
                <MudTh>Fecha</MudTh>
                <MudTh>Estado</MudTh>
                <MudTh>Anulado</MudTh>
                <MudTh Align="Right"></MudTh>
            </HeaderContent>

            <RowTemplate Context="row">

                <MudTd>@row.Id</MudTd>
                <MudTd>@row.Cliente</MudTd>
                <MudTd>@row.FechaEntrega?.ToString("dd/MM/yyyy")</MudTd>

                <MudTd>
                    <MudChip T="string"
                             Color="@(row.Estado == 0 ? Color.Error : Color.Info)"
                             Variant="Variant.Filled"
                             Size="Size.Small">
                        @(row.Estado == 0 ? "Pendiente" : "Cerrado")
                    </MudChip>
                </MudTd>

                <MudTd>
                    <MudChip T="string"
                             Color="@(row.Activo == true ? Color.Success : Color.Error)"
                             Variant="Variant.Filled"
                             Size="Size.Small"
                             Clickable="@(row.Activo == true)"
                             Style="@(row.Activo == true ? "cursor:pointer;" : "cursor:default;")"
                             OnClick="@(row.Activo == true ? (() => ConfirmarAnulacion(row)) : null)">
                        @(row.Activo == true ? "Activo" : "Anulado")
                    </MudChip>
                </MudTd>

                <MudTd Align="Align.Right">
                    <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                   Color="Color.Primary"
                                   OnClick="@(() => Navigation.NavigateTo($"/pedidos/ver/{row.Id}"))" />
                    <!-- Aprobar (solo Pendiente + Activo) -->
                    @if (row.Estado == 0 && row.Activo==true)
                    {
                        <MudIconButton Icon="@Icons.Material.Filled.CheckCircle"
                                       Color="Color.Success"
                                       Title="Aprobar pedido"
                                       OnClick="@(() => ConfirmarAprobacion(row))" />
                    }
                </MudTd>

            </RowTemplate>

            <NoRecordsContent>
                <MudText Color="Color.Secondary">
                    No se encontraron pedidos
                </MudText>
            </NoRecordsContent>

        </MudTable>

    </MudPaper>

</MudContainer>


@code {

    string? _cliente;
    DateTime? _fechaDesde;
    DateTime? _fechaHasta;

    bool _loading;
    MudTable<PedidoDto>? _table;

    private bool _isNavigating = false;

    private void GoNuevoPedido()
    {
        if (_isNavigating)
            return;

        _isNavigating = true;

        Navigation.NavigateTo("/pedidos/nuevo");
    }

    async Task<TableData<PedidoDto>> LoadServerData(
    TableState state,
    CancellationToken cancellationToken)
    {
        if (_loading)
        {
            return new TableData<PedidoDto>
            {
                Items = new List<PedidoDto>(),
                TotalItems = 0
            };
        }

        _loading = true;

        try
        {
            var result = await PedidoService.SearchAsync(new PedidoFilterDto
            {
                Cliente = _cliente,
                FechaDesde = _fechaDesde.HasValue
                    ? DateOnly.FromDateTime(_fechaDesde.Value)
                    : null,
                FechaHasta = _fechaHasta.HasValue
                    ? DateOnly.FromDateTime(_fechaHasta.Value)
                    : null,
                Page = state.Page,
                PageSize = state.PageSize
            }, cancellationToken);

            return new TableData<PedidoDto>
            {
                Items = result.Items,
                TotalItems = result.TotalItems
            };
        }
        finally
        {
            _loading = false;
        }
    }

    async Task Buscar()
    {
        if (_loading) return;

        if (_table is not null)
        {
            _table.NavigateTo(0);
            await _table.ReloadServerData();
        }
    }

    async Task ConfirmarAprobacion(PedidoDto pedido)
    {
        var options = new DialogOptions
        {
            CloseButton = true,   // 👈 MUESTRA LA ❌
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        bool? result = await DialogService.ShowMessageBox(
            title: "Confirmar aprobación",
            message: $"¿Desea aprobar el pedido #{pedido.Id}?",
            yesText: "Aprobar",
            options: options,
            cancelText: "Cancelar");

        if (result == true)
        {
            Snackbar.Add(
                "Acción de aprobar (solo mensaje por ahora)",
                Severity.Info,
                options =>
                {
                    options.CloseAfterNavigation = true;
                });
        }
    }

    async Task ConfirmarAnulacion(PedidoDto pedido)
    {
        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        bool? result = await DialogService.ShowMessageBox(
            title: "Confirmar anulación",
            message: $"¿Está seguro que desea anular el pedido #{pedido.Id}?",
            yesText: "Anular",
            cancelText: "Cancelar",
            options: options);

        if (result == true)
        {
            // 🔴 AQUÍ irá luego tu llamada al backend
            // await PedidoService.AnularAsync(pedido.Id);

            Snackbar.Add(
                $"Pedido #{pedido.Id} anulado correctamente",
                Severity.Success,
                options =>
                {
                    options.CloseAfterNavigation = true;
                });

            // 🔄 Refrescar tabla
            if (_table is not null)
                await _table.ReloadServerData();
        }
    }
}
